{% extends 'base.html' %}

{% block title %}Home{% endblock %}


{% block content %}
<div class="container">
    <h2>Personal Finance Tracker</h2>
<pre>{{ expense_summary|json_script:"expense-summary" }}</pre>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3>Total Salary: ${{ salary }}</h3>
            <h3>Total Expenses: ${{ total_expenses }}</h3>
            <h3>Remaining Savings: ${{ remaining_savings }}</h3>
        </div>
    
        <!-- Right Section: Pie Chart -->
        <div>
            <canvas id="expense-chart" width="400" height="400"></canvas>
        </div>
    </div>
    
    
    
    
    
    <br><br>
    
    <h3>Your Goals</h3>
    <ul>
        {% for goal in goal_summary %}
            <li>
                <div>
                    <h4>{{ goal.name }} - 
                        {% if goal.progress >= 100 %}
                            <span>Complete</span>
                        {% else %}
                            Progress: {{ goal.progress }}%
                        {% endif %}
                    </h4>
                    <p>Current Balance: ${{ goal.current_amount }} / Target: ${{ goal.target_amount }}</p>
                    <p>Deadline: {{ goal.deadline }}</p>
                    
                    {% if goal.progress < 100 %}
                        <form method="POST" action="{% url 'home' %}">
                            {% csrf_token %}
                            <input type="hidden" name="goal_id" value="{{ goal.id }}">
                            <label for="amount_{{ goal.id }}">Add Money:</label>
                            <input type="number" step="0.01" name="amount" id="amount_{{ goal.id }}" required>
                            <button type="submit" name="add_money_to_goal">Add Money</button>
                        </form>
                    {% else %}
                        <p><strong>Goal Completed!</strong></p>
                    {% endif %}
                </div>
            </li>
        {% endfor %}
    </ul>
    
    {% if goal_summary|length < 3 %}
        {% with goals_completed=0 %}
            {% for goal in goal_summary %}
                {% if goal.progress >= 100 %}
                    {% with goals_completed=goals_completed|add:1 %}
                    {% endwith %}
                {% endif %}
            {% endfor %}
            {% if goals_completed == 0 %}
                <a href="{% url 'goals:add_goal' %}">
                    <button>Add New Goal</button>
                </a>
            {% endif %}
        {% endwith %}
    {% endif %}
    
    

    <br><br>
</div>

<script id="expense-data" type="application/json">
    {{ expense_summary|json_script:"expense-summary" }}
</script>

<script>
    const expenseSummary = JSON.parse(document.getElementById('expense-summary').textContent);
    const expenseLabels = expenseSummary.map(item => item.category__name);
    const expenseValues = expenseSummary.map(item => item.total_spent);
    const ctx = document.getElementById('expense-chart').getContext('2d');
    const expenseChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: expenseLabels,
            datasets: [{
                data: expenseValues,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
</script>
{% endblock %}

